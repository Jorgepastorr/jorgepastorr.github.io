



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="http://kubernetes.jorgepastorr.tk:50022/Instalaci%C3%B3n/">
      
      
        <meta name="author" content="Jorge Pastor">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../images/kubernetes.png">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-4.6.3">
    
    
      
        <title>Instalación - Proyecto Kubernetes</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.adb8469c.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#3f51b5">
      
    
    
      <script src="../assets/javascripts/modernizr.86422ebf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="500" height="500" viewBox="0 0 500 500" id="__gitlab"><path fill="currentColor" d="M93.667 473.347l90.684-279.097H2.983l90.684 279.097z" transform="translate(156.198 1.16)"/><path fill="currentColor" d="M221.333 473.345L130.649 194.25H3.557l217.776 279.095z" transform="translate(28.531 1.16)" opacity=".7"/><path fill="currentColor" d="M32 195.155L4.441 279.97a18.773 18.773 0 0 0 6.821 20.99l238.514 173.29L32 195.155z" transform="translate(.089 .256)" opacity=".5"/><path fill="currentColor" d="M2.667-84.844h127.092L75.14-252.942c-2.811-8.649-15.047-8.649-17.856 0L2.667-84.844z" transform="translate(29.422 280.256)"/><path fill="currentColor" d="M2.667 473.345L93.351 194.25h127.092L2.667 473.345z" transform="translate(247.198 1.16)" opacity=".7"/><path fill="currentColor" d="M221.334 195.155l27.559 84.815a18.772 18.772 0 0 1-6.821 20.99L3.557 474.25l217.777-279.095z" transform="translate(246.307 .256)" opacity=".5"/><path fill="currentColor" d="M130.667-84.844H3.575l54.618-168.098c2.811-8.649 15.047-8.649 17.856 0l54.618 168.098z" transform="translate(336.974 280.256)"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#instalacion-entorno-pruebas" tabindex="0" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="http://kubernetes.jorgepastorr.tk:50022" title="Proyecto Kubernetes" aria-label="Proyecto Kubernetes" class="md-header-nav__button md-logo">
          
            <img alt="logo" src="../images/logokubernetes.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Proyecto Kubernetes
            </span>
            <span class="md-header-nav__topic">
              
                Instalación
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" aria-label="search" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://gitlab.com/jorgepastorr/kubernetes/" title="Go to repository" class="md-source" data-md-source="gitlab">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__gitlab" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    jorgepastorr/kubernetes
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="http://kubernetes.jorgepastorr.tk:50022" title="Proyecto Kubernetes" class="md-nav__button md-logo">
      
        <img alt="logo" src="../images/logokubernetes.png" width="48" height="48">
      
    </a>
    Proyecto Kubernetes
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://gitlab.com/jorgepastorr/kubernetes/" title="Go to repository" class="md-source" data-md-source="gitlab">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__gitlab" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    jorgepastorr/kubernetes
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Kubernetes" class="md-nav__link">
      Kubernetes
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Instalación
      </label>
    
    <a href="./" title="Instalación" class="md-nav__link md-nav__link--active">
      Instalación
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#instalacion-entorno-pruebas" class="md-nav__link">
    Instalación entorno pruebas
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#comandos-basicos-minikube" class="md-nav__link">
    comandos basicos minikube
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#instalacion-cluster-real" class="md-nav__link">
    Instalación cluster real
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#requisitos" class="md-nav__link">
    Requisitos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#instalacion" class="md-nav__link">
    Instalación
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#preparacion-de-nodos" class="md-nav__link">
    Preparación de nodos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#instalar-servicios" class="md-nav__link">
    Instalar servicios
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creacion-de-master" class="md-nav__link">
    Creación de master
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#juntar-nodos-worker" class="md-nav__link">
    Juntar nodos worker
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#eliminar-un-nodo" class="md-nav__link">
    Eliminar un nodo
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#instalacion-cluster-eks" class="md-nav__link">
    Instalación cluster EKS
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#requisitos_1" class="md-nav__link">
    Requisitos
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#instalar-aws-clie" class="md-nav__link">
    Instalar aws-clie
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#instalar-eksctl" class="md-nav__link">
    Instalar eksctl
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#instalar-kubectl" class="md-nav__link">
    Instalar kubectl
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#desplegar-cluster" class="md-nav__link">
    Desplegar cluster
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#eliminar-cluster" class="md-nav__link">
    Eliminar cluster
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Pod/" title="Pod" class="md-nav__link">
      Pod
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Replicaset/" title="Replicaset" class="md-nav__link">
      Replicaset
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Deployment/" title="Deployment" class="md-nav__link">
      Deployment
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Services_Endpoints/" title="Services & Endpoints" class="md-nav__link">
      Services & Endpoints
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Namespaces/" title="Namespaces" class="md-nav__link">
      Namespaces
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Limits/" title="Limits" class="md-nav__link">
      Limits
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Probes/" title="Probes" class="md-nav__link">
      Probes
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../ConfigMaps/" title="ConfigMaps & Environtment" class="md-nav__link">
      ConfigMaps & Environtment
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Secrets/" title="Secrets" class="md-nav__link">
      Secrets
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Volumes/" title="Volumes" class="md-nav__link">
      Volumes
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../RBAC/" title="RBAC" class="md-nav__link">
      RBAC
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Ingres/" title="Ingres" class="md-nav__link">
      Ingres
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../aws-cli/" title="AWS-clie" class="md-nav__link">
      AWS-clie
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../aws/awseks/" title="AWS EKS" class="md-nav__link">
      AWS EKS
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-17" type="checkbox" id="nav-17">
    
    <label class="md-nav__link" for="nav-17">
      presentacion
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-17">
        presentacion
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../presentacion/diapositiva.html" title="diapositiva" class="md-nav__link">
      diapositiva
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../presentacion/diapositiva.pdf" title="diapositiva-pdf" class="md-nav__link">
      diapositiva-pdf
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../presentacion/videos/" title="Videos" class="md-nav__link">
      Videos
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#instalacion-entorno-pruebas" class="md-nav__link">
    Instalación entorno pruebas
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#comandos-basicos-minikube" class="md-nav__link">
    comandos basicos minikube
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#instalacion-cluster-real" class="md-nav__link">
    Instalación cluster real
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#requisitos" class="md-nav__link">
    Requisitos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#instalacion" class="md-nav__link">
    Instalación
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#preparacion-de-nodos" class="md-nav__link">
    Preparación de nodos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#instalar-servicios" class="md-nav__link">
    Instalar servicios
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creacion-de-master" class="md-nav__link">
    Creación de master
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#juntar-nodos-worker" class="md-nav__link">
    Juntar nodos worker
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#eliminar-un-nodo" class="md-nav__link">
    Eliminar un nodo
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#instalacion-cluster-eks" class="md-nav__link">
    Instalación cluster EKS
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#requisitos_1" class="md-nav__link">
    Requisitos
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#instalar-aws-clie" class="md-nav__link">
    Instalar aws-clie
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#instalar-eksctl" class="md-nav__link">
    Instalar eksctl
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#instalar-kubectl" class="md-nav__link">
    Instalar kubectl
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#desplegar-cluster" class="md-nav__link">
    Desplegar cluster
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#eliminar-cluster" class="md-nav__link">
    Eliminar cluster
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://gitlab.com/jorgepastorr/kubernetes/edit/master/docs/Instalación.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                  <h1>Instalación</h1>
                
                <h2 id="instalacion-entorno-pruebas">Instalación entorno pruebas</h2>
<p>Para el entorno de pruebas es necesario instalar docker, kubectl y minikube.</p>
<p><strong>kubectl</strong> es la aplicación con la que se gestiona kuberetes.</p>
<p><strong>minikube</strong> es un entorno de pruebas muy útil para aprender a utilizar kubernetes, este genera un cluster de nodos donde se pueden hacer todo tipo de pruebas.</p>
<p>https://docs.docker.com/install/linux/docker-ce/debian/</p>
<p>https://kubernetes.io/docs/tasks/tools/install-kubectl/</p>
<p>https://kubernetes.io/es/docs/tasks/tools/install-minikube/</p>
<h3 id="comandos-basicos-minikube">comandos basicos minikube</h3>
<div class="codehilite"><pre><span></span><code>sudo minikube status
sudo minikube start
sudo minikube stop
sudo minikube delete
sudo minikube  -h
</code></pre></div>

<h2 id="instalacion-cluster-real">Instalación cluster real</h2>
<h3 id="requisitos">Requisitos</h3>
<ul>
<li>Sistema operativo: Ubuntu 16.04+, Debian9+, centOS7, Red Had Enterprise Lihnux (RHEL)7, Fedora25+, HypriotOS v1.0.1+</li>
<li>2GB como mínimo de RAM</li>
<li>2 CPUs como mínimo</li>
<li>Conectividad entre todas las máquinas del cluster</li>
<li>Nombre de host único, dirección MAC y product_uuid para cada nodo.</li>
<li>desactivar Swap para el correcto funcionamiento de kubelet</li>
<li>Ciertos puertos abiertos en las máquinas</li>
</ul>
<p><strong>Control-plane node(s)</strong></p>
<table>
<thead>
<tr>
<th>Protocol</th>
<th>Direction</th>
<th>Port Range</th>
<th>Purpose</th>
<th>Used By</th>
</tr>
</thead>
<tbody>
<tr>
<td>TCP</td>
<td>Inbound</td>
<td>6443*</td>
<td>Kubernetes API server</td>
<td>All</td>
</tr>
<tr>
<td>TCP</td>
<td>Inbound</td>
<td>2379-2380</td>
<td>etcd server client API</td>
<td>kube-apiserver, etcd</td>
</tr>
<tr>
<td>TCP</td>
<td>Inbound</td>
<td>10250</td>
<td>Kubelet API</td>
<td>Self, Control plane</td>
</tr>
<tr>
<td>TCP</td>
<td>Inbound</td>
<td>10251</td>
<td>kube-scheduler</td>
<td>Self</td>
</tr>
<tr>
<td>TCP</td>
<td>Inbound</td>
<td>10252</td>
<td>kube-controller-manager</td>
<td>Self</td>
</tr>
</tbody>
</table>
<p><strong>Worker node(s)</strong></p>
<table>
<thead>
<tr>
<th>Protocol</th>
<th>Direction</th>
<th>Port Range</th>
<th>Purpose</th>
<th>Used By</th>
</tr>
</thead>
<tbody>
<tr>
<td>TCP</td>
<td>Inbound</td>
<td>10250</td>
<td>Kubelet API</td>
<td>Self, Control plane</td>
</tr>
<tr>
<td>TCP</td>
<td>Inbound</td>
<td>30000-32767</td>
<td>NodePort Services†</td>
<td>All</td>
</tr>
</tbody>
</table>
<p><strong>CNI ports on both control-plane and worker nodes</strong></p>
<p>Según la red de pods que se configure en el cluster también es necesario abrir los puertos necesarios para el modelo de red</p>
<table>
<thead>
<tr>
<th>Protocol</th>
<th>Port Number</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>TCP</td>
<td>179</td>
<td>Calico BGP network</td>
</tr>
<tr>
<td>TCP</td>
<td>9099</td>
<td>Calico felix (health check)</td>
</tr>
<tr>
<td>UDP</td>
<td>8285</td>
<td>Flannel</td>
</tr>
<tr>
<td>UDP</td>
<td>8472</td>
<td>Flannel</td>
</tr>
<tr>
<td>TCP</td>
<td>6781-6784</td>
<td>Weave Net</td>
</tr>
<tr>
<td>UDP</td>
<td>6783-6784</td>
<td>Weave Net</td>
</tr>
</tbody>
</table>
<h3 id="instalacion">Instalación</h3>
<p>En este ejemplo de instalación se muestra como instalar un cluster de tres máquinas, un master ( control-plane ) y dos workers, esta instalación se realiza en máquinas virtuales fedora27 y la tipología del master es <em>stacked</em>.</p>
<h4 id="preparacion-de-nodos">Preparación de nodos</h4>
<p>Asignar hostname a cada nodo</p>
<div class="codehilite"><pre><span></span><code>hostnamectl set-hostname master
hostnamectl set-hostname node1
hostnamectl set-hostname node2
</code></pre></div>

<p>Deshabilitar swap</p>
<div class="codehilite"><pre><span></span><code>swapoff -a
sed -i <span class="s1">&#39;/ swap / s/^/#/&#39;</span> /etc/fstab
</code></pre></div>

<p>Resolución de nombres</p>
<div class="codehilite"><pre><span></span><code><span class="o">[</span>jorge@master ~<span class="o">]</span>$ cat /etc/hosts
<span class="m">127</span>.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
<span class="m">192</span>.168.122.2 master
<span class="m">192</span>.168.122.3 node1
<span class="m">192</span>.168.122.4 node2
</code></pre></div>

<p>Ip fijas</p>
<div class="codehilite"><pre><span></span><code><span class="o">[</span>jorge@node1 ~<span class="o">]</span>$ cat /etc/sysconfig/network-scripts/ifcfg-enp1s0 
<span class="nv">TYPE</span><span class="o">=</span>Ethernet
<span class="nv">PROXY_METHOD</span><span class="o">=</span>none
<span class="nv">BROWSER_ONLY</span><span class="o">=</span>no
<span class="nv">DEFROUTE</span><span class="o">=</span>yes
<span class="nv">IPV4_FAILURE_FATAL</span><span class="o">=</span>no
<span class="nv">IPV6INIT</span><span class="o">=</span>yes
<span class="nv">IPV6_AUTOCONF</span><span class="o">=</span>yes
<span class="nv">IPV6_DEFROUTE</span><span class="o">=</span>yes
<span class="nv">IPV6_FAILURE_FATAL</span><span class="o">=</span>no
<span class="nv">IPV6_ADDR_GEN_MODE</span><span class="o">=</span>stable-privacy
<span class="nv">NAME</span><span class="o">=</span>enp1s0
<span class="nv">UUID</span><span class="o">=</span>ed734a8b-a63b-3d9e-8016-b1a7a731f08a
<span class="nv">ONBOOT</span><span class="o">=</span>yes
<span class="nv">AUTOCONNECT_PRIORITY</span><span class="o">=</span>-999

<span class="nv">BOOTPROTO</span><span class="o">=</span>none
<span class="nv">DEVICE</span><span class="o">=</span>enp1s0
<span class="nv">IPADDR</span><span class="o">=</span><span class="m">192</span>.168.122.3
<span class="nv">NETMASK</span><span class="o">=</span><span class="m">255</span>.255.255.0
<span class="nv">GATEWAY</span><span class="o">=</span><span class="m">192</span>.168.122.1
<span class="nv">DNS1</span><span class="o">=</span><span class="m">192</span>.168.122.1
<span class="nv">DNS2</span><span class="o">=</span><span class="m">1</span>.1.1.1
</code></pre></div>

<h4 id="instalar-servicios">Instalar servicios</h4>
<p>En todos los nodos es necesario instalar docker, kubelet, kubectl, kubeadm.</p>
<p><strong>Instalación de docker</strong></p>
<p>https://docs.docker.com/engine/install/fedora/</p>
<p><strong>Instalación de kubeam, kubectl, kubelet</strong> </p>
<div class="codehilite"><pre><span></span><code><span class="c1"># añadir repositorio de kubernetes</span>
cat <span class="s">&lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span>
<span class="s">[kubernetes]</span>
<span class="s">name=Kubernetes</span>
<span class="s">baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-\$basearch</span>
<span class="s">enabled=1</span>
<span class="s">gpgcheck=1</span>
<span class="s">repo_gpgcheck=1</span>
<span class="s">gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg</span>
<span class="s">exclude=kubelet kubeadm kubectl</span>
<span class="s">EOF</span>

<span class="c1"># Set SELinux in permissive mode (effectively disabling it)</span>
setenforce <span class="m">0</span>
sed -i <span class="s1">&#39;s/^SELINUX=enforcing$/SELINUX=permissive/&#39;</span> /etc/selinux/config

<span class="c1"># instalar servicios y abilitar kubelet</span>
dnf install -y kubelet kubeadm kubectl --disableexcludes<span class="o">=</span>kubernetes
systemctl <span class="nb">enable</span> --now kubelet
</code></pre></div>

<ul>
<li>Esta instalación es para distribuciones fedora para otras distribuciones consultar <a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">aquí</a></li>
</ul>
<p>Verificar instalación de kubeadm</p>
<div class="codehilite"><pre><span></span><code><span class="o">[</span>root@master jorge<span class="o">]</span><span class="c1"># kubeadm version</span>
kubeadm version: <span class="p">&amp;</span>version.Info<span class="o">{</span>Major:<span class="s2">&quot;1&quot;</span>, Minor:<span class="s2">&quot;18&quot;</span>, GitVersion:<span class="s2">&quot;v1.18.2&quot;</span>, GitCommit:<span class="s2">&quot;52c56ce7a8272c798dbc29846288d7cd9fbae032&quot;</span>, GitTreeState:<span class="s2">&quot;clean&quot;</span>, BuildDate:<span class="s2">&quot;2020-04-16T11:54:15Z&quot;</span>, GoVersion:<span class="s2">&quot;go1.13.9&quot;</span>, Compiler:<span class="s2">&quot;gc&quot;</span>, Platform:<span class="s2">&quot;linux/amd64&quot;</span><span class="o">}</span>
</code></pre></div>

<h4 id="creacion-de-master">Creación de master</h4>
<p>En la creación del master hay que tener en que red se crearan los Pods, esta opción kubernetes lo deja en addons externos, puedes elegir entre diferentes opciones que encontrarás en este <a href="https://kubernetes.io/docs/concepts/cluster-administration/addons/#networking-and-network-policy">documento</a>. En esta instalación se asignara el addon calico.</p>
<blockquote>
<p><strong>Nota</strong>: El dns del cluster CoreDNS no se iniciará si no hay antes una red de Pods instalada.</p>
</blockquote>
<p>Iniciar configuración del master con red de pod</p>
<div class="codehilite"><pre><span></span><code>kubeadm init --pod-network-cidr<span class="o">=</span><span class="m">192</span>.168.0.0/16
</code></pre></div>

<blockquote>
<p>Este comando descarga imágenes que necesita el cluster para funcionar y tarda un rato en completarse.</p>
</blockquote>
<p>El comando anterior acaba mostrando las siguientes instrucciones a realizar, para la finalización de la instalación del master.</p>
<div class="codehilite"><pre><span></span><code>Your Kubernetes control-plane has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

  mkdir -p <span class="nv">$HOME</span>/.kube
  sudo cp -i /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
  sudo chown <span class="k">$(</span>id -u<span class="k">)</span>:<span class="k">$(</span>id -g<span class="k">)</span> <span class="nv">$HOME</span>/.kube/config

You should now deploy a pod network to the cluster.
Run <span class="s2">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

Then you can join any number of worker nodes by running the following on each as root:

kubeadm join <span class="m">192</span>.168.122.2:6443 --token 13whh6.k1mj5fu316n7kjfy <span class="se">\</span>
    --discovery-token-ca-cert-hash sha256:6a0e0da8c83e9136a099f2ae11d17e39a9f6697fcc910c60c7634aef30a0dc1f 
</code></pre></div>

<blockquote>
<p>Es muy importante guardarse bien la línea de <code>kubeadm join</code> ya que con esta juntaremos los nodos al master.</p>
</blockquote>
<p>En caso de no querer gestionar el cluster como root, y quererlo gestionar como usuario.</p>
<div class="codehilite"><pre><span></span><code><span class="o">[</span>jorge@master ~<span class="o">]</span>$ mkdir -p <span class="nv">$HOME</span>/.kube
<span class="o">[</span>jorge@master ~<span class="o">]</span>$ sudo cp -i /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
<span class="o">[</span>jorge@master ~<span class="o">]</span>$ sudo chown <span class="k">$(</span>id -u<span class="k">)</span>:<span class="k">$(</span>id -g<span class="k">)</span> <span class="nv">$HOME</span>/.kube/config
</code></pre></div>

<p>Aplico el addon para gestionar las redes de Pods</p>
<div class="codehilite"><pre><span></span><code>kubectl apply -f https://docs.projectcalico.org/v3.11/manifests/calico.yaml
</code></pre></div>

<p><strong>Esta opción no es recomendable</strong>: Por razones de seguridad por defecto el nodo master no ejecuta Pods del cluster, en caso de querer que haga de master y nodo simultáneamente, por ejemplo para entornos de pruebas de un cluster de un solo nodo, aplicar la siguiente opción.</p>
<div class="codehilite"><pre><span></span><code>kubectl taint nodes --all node-role.kubernetes.io/master-
</code></pre></div>

<h4 id="juntar-nodos-worker">Juntar nodos worker</h4>
<p>Para juntar un worker al nodo master simplemente hay que ejecutar <code>kubeadm join</code> con el token del master.</p>
<div class="codehilite"><pre><span></span><code>kubeadm join <span class="m">192</span>.168.122.2:6443 --token namzwa.gri0onsuwamo19gg <span class="se">\</span>
    --discovery-token-ca-cert-hash sha256:3bd21a07fdbaf780d5bf8103a5dff2a46945219393fda74897579d43524c931a 
</code></pre></div>

<ul>
<li>Si esta opción muestra algún error, es posible que el firewall del master este rechazando la conexión, comprobar los puertos accesibles por el firewall.</li>
<li>En caso de no disponer del token, siempre se puede crear uno nuevo desde el master con <code>kubeadm token create --print-join-command</code></li>
</ul>
<p>Ahora desde el master se puede ver que el nodo se a añadido al master, es una buena practica asignarle algún label al nodo, para identificar que modo de nodo es y por si se quieren asignar pods específicos al nodo.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># nodo recien añadido</span>
<span class="o">[</span>jorge@master ~<span class="o">]</span>$ kubectl get nodes
NAME     STATUS   ROLES    AGE   VERSION
master   Ready    master   22m   v1.18.2
node1    Ready    &lt;none&gt;   19m   v1.18.2

<span class="c1"># asignar label de tipo de nodo</span>
<span class="o">[</span>jorge@master ~<span class="o">]</span>$ kubectl label node node1 node-role.kubernetes.io/worker<span class="o">=</span>worker
node/node1 labeled

<span class="o">[</span>jorge@master ~<span class="o">]</span>$ kubectl get nodes
NAME     STATUS   ROLES    AGE   VERSION
master   Ready    master   27m   v1.18.2
node1    Ready    worker   23m   v1.18.2

<span class="c1"># asignar label extra de identificación de nodo</span>
<span class="o">[</span>jorge@master ~<span class="o">]</span>$ kubectl label nodes node1 <span class="nv">node</span><span class="o">=</span>worker1
node/node1 labeled

<span class="c1"># visualizar labels de nodos</span>
<span class="o">[</span>jorge@master ~<span class="o">]</span>$ kubectl get nodes --show-labels
</code></pre></div>

<h4 id="eliminar-un-nodo">Eliminar un nodo</h4>
<p>Desde el nodo master drenar el nodo que queremos eliminar, una vez drenado de todas sus tareas eliminarlo.</p>
<div class="codehilite"><pre><span></span><code>kubectl drain &lt;node name&gt; --delete-local-data --force --ignore-daemonsets
kubectl delete node &lt;node name&gt;
</code></pre></div>

<p>En el nodo que se a eliminado del cluster restablecer la configuración inicial</p>
<div class="codehilite"><pre><span></span><code>kubeadm reset
</code></pre></div>

<p>El proceso de reinicio no reinicia ni limpia las reglas de iptables o las tablas de IPVS. Si desea restablecer iptables, debe hacerlo manualmente:</p>
<div class="codehilite"><pre><span></span><code>iptables -F <span class="o">&amp;&amp;</span> iptables -t nat -F <span class="o">&amp;&amp;</span> iptables -t mangle -F <span class="o">&amp;&amp;</span> iptables -X
</code></pre></div>

<p>Si desea restablecer las tablas IPVS, debe ejecutar el siguiente comando:</p>
<div class="codehilite"><pre><span></span><code>ipvsadm -C
</code></pre></div>

<h2 id="instalacion-cluster-eks">Instalación cluster EKS</h2>
<p>La instalación de un cluster mediante la herramienta <code>eksctl</code> de aws permite desplegar un cluster rápidamente en la plataforma aws.</p>
<h3 id="requisitos_1">Requisitos</h3>
<h4 id="instalar-aws-clie">Instalar aws-clie</h4>
<p><code>aws-clie</code> Permite gestionar la api de aws desde la linea de comandos de nuestra terminal, <a href="../aws-cli/">instalar aws-clie</a></p>
<h4 id="instalar-eksctl">Instalar eksctl</h4>
<p><code>eksctl</code> es el herramienta que proporciona aws para la creación de clusteres kubernetes en la nube aws desde una terminal</p>
<div class="codehilite"><pre><span></span><code>curl --silent --location <span class="s2">&quot;https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_</span><span class="k">$(</span>uname -s<span class="k">)</span><span class="s2">_amd64.tar.gz&quot;</span> <span class="p">|</span> tar xz -C /tmp
sudo mv /tmp/eksctl /usr/local/bin
eksctl version
</code></pre></div>

<h4 id="instalar-kubectl">Instalar kubectl</h4>
<p><code>kubectl</code> es necesario para acceder a la api del cluster y gestionarlo.</p>
<div class="codehilite"><pre><span></span><code>cat <span class="s">&lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span>
<span class="s">[kubernetes]</span>
<span class="s">name=Kubernetes</span>
<span class="s">baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64</span>
<span class="s">enabled=1</span>
<span class="s">gpgcheck=1</span>
<span class="s">repo_gpgcheck=1</span>
<span class="s">gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg</span>
<span class="s">EOF</span>

dnf install -y kubectl
kubectl version
</code></pre></div>

<ul>
<li>Instalación otras distribuciones <a href="https://kubernetes.io/es/docs/tasks/tools/install-kubectl/#instalar-kubectl">aqui</a></li>
</ul>
<h3 id="desplegar-cluster">Desplegar cluster</h3>
<p>Al desplegar un cluster con <code>eksctl</code>  se han de tener en cuenta opciones como: la región donde desplegar, el número de nodos, el tipo ne nodo, entre otras opciones adicionales mostradas con <code>eksctl create cluster -h</code>.</p>
<p>En el siguiente ejemplo se despliega un cluster en la región de londres de dos nodos con 2 CPU y 2GB RAM cada uno, con acceso mediante ssh desde el host que se crea.</p>
<blockquote>
<p>La instalación del cluster tarda entre 10 y 15 minutos.</p>
</blockquote>
<div class="codehilite"><pre><span></span><code>eksctl create cluster <span class="se">\</span>
--name first-eks <span class="se">\</span>
--region eu-west-2 <span class="se">\</span>
--nodegroup-name standard-nodes <span class="se">\</span>
--node-type t3.small <span class="se">\</span>
--nodes <span class="m">2</span> <span class="se">\</span>
--nodes-min <span class="m">2</span> <span class="se">\</span>
--nodes-max <span class="m">2</span> <span class="se">\</span>
--ssh-access <span class="se">\</span>
--ssh-public-key .ssh/id_rsa.pub <span class="se">\</span>
--managed

<span class="o">[</span>ℹ<span class="o">]</span>  eksctl version <span class="m">0</span>.18.0
<span class="o">[</span>ℹ<span class="o">]</span>  using region eu-west-2
<span class="o">[</span>ℹ<span class="o">]</span>  setting availability zones to <span class="o">[</span>eu-west-2a eu-west-2b eu-west-2c<span class="o">]</span>
<span class="o">[</span>ℹ<span class="o">]</span>  subnets <span class="k">for</span> eu-west-2a - public:192.168.0.0/19 private:192.168.96.0/19
<span class="o">[</span>ℹ<span class="o">]</span>  subnets <span class="k">for</span> eu-west-2b - public:192.168.32.0/19 private:192.168.128.0/19
<span class="o">[</span>ℹ<span class="o">]</span>  subnets <span class="k">for</span> eu-west-2c - public:192.168.64.0/19 private:192.168.160.0/19
<span class="o">[</span>ℹ<span class="o">]</span>  using SSH public key <span class="s2">&quot;.ssh/id_rsa.pub&quot;</span> as <span class="s2">&quot;eksctl-first-eks-nodegroup-standard-nodes-9a:84:e3:29:f3:d4:5d:4b:23:18:da:b6:b5:bd:fb:68&quot;</span> 
<span class="o">[</span>ℹ<span class="o">]</span>  using Kubernetes version <span class="m">1</span>.15
<span class="o">[</span>ℹ<span class="o">]</span>  creating EKS cluster <span class="s2">&quot;first-eks&quot;</span> in <span class="s2">&quot;eu-west-2&quot;</span> region with managed nodes
<span class="o">[</span>ℹ<span class="o">]</span>  will create <span class="m">2</span> separate CloudFormation stacks <span class="k">for</span> cluster itself and the initial managed nodegroup
<span class="o">[</span>ℹ<span class="o">]</span>  <span class="k">if</span> you encounter any issues, check CloudFormation console or try <span class="s1">&#39;eksctl utils describe-stacks --region=eu-west-2 --cluster=first-eks&#39;</span>
<span class="o">[</span>ℹ<span class="o">]</span>  CloudWatch logging will not be enabled <span class="k">for</span> cluster <span class="s2">&quot;first-eks&quot;</span> in <span class="s2">&quot;eu-west-2&quot;</span>
<span class="o">[</span>ℹ<span class="o">]</span>  you can <span class="nb">enable</span> it with <span class="s1">&#39;eksctl utils update-cluster-logging --region=eu-west-2 --cluster=first-eks&#39;</span>
<span class="o">[</span>ℹ<span class="o">]</span>  Kubernetes API endpoint access will use default of <span class="o">{</span><span class="nv">publicAccess</span><span class="o">=</span>true, <span class="nv">privateAccess</span><span class="o">=</span>false<span class="o">}</span> <span class="k">for</span> cluster <span class="s2">&quot;first-eks&quot;</span> in <span class="s2">&quot;eu-west-2&quot;</span>
<span class="o">[</span>ℹ<span class="o">]</span>  <span class="m">2</span> sequential tasks: <span class="o">{</span> create cluster control plane <span class="s2">&quot;first-eks&quot;</span>, create managed nodegroup <span class="s2">&quot;standard-nodes&quot;</span> <span class="o">}</span>
<span class="o">[</span>ℹ<span class="o">]</span>  building cluster stack <span class="s2">&quot;eksctl-first-eks-cluster&quot;</span>
<span class="o">[</span>ℹ<span class="o">]</span>  deploying stack <span class="s2">&quot;eksctl-first-eks-cluster&quot;</span>
<span class="o">[</span>ℹ<span class="o">]</span>  building managed nodegroup stack <span class="s2">&quot;eksctl-first-eks-nodegroup-standard-nodes&quot;</span>
<span class="o">[</span>ℹ<span class="o">]</span>  deploying stack <span class="s2">&quot;eksctl-first-eks-nodegroup-standard-nodes&quot;</span>
<span class="o">[</span>✔<span class="o">]</span>  all EKS cluster resources <span class="k">for</span> <span class="s2">&quot;first-eks&quot;</span> have been created
<span class="o">[</span>✔<span class="o">]</span>  saved kubeconfig as <span class="s2">&quot;/home/debian/.kube/config&quot;</span>
<span class="o">[</span>ℹ<span class="o">]</span>  nodegroup <span class="s2">&quot;standard-nodes&quot;</span> has <span class="m">2</span> node<span class="o">(</span>s<span class="o">)</span>
<span class="o">[</span>ℹ<span class="o">]</span>  node <span class="s2">&quot;ip-192-168-62-60.eu-west-2.compute.internal&quot;</span> is ready
<span class="o">[</span>ℹ<span class="o">]</span>  node <span class="s2">&quot;ip-192-168-67-118.eu-west-2.compute.internal&quot;</span> is ready
<span class="o">[</span>ℹ<span class="o">]</span>  waiting <span class="k">for</span> at least <span class="m">2</span> node<span class="o">(</span>s<span class="o">)</span> to become ready in <span class="s2">&quot;standard-nodes&quot;</span>
<span class="o">[</span>ℹ<span class="o">]</span>  nodegroup <span class="s2">&quot;standard-nodes&quot;</span> has <span class="m">2</span> node<span class="o">(</span>s<span class="o">)</span>
<span class="o">[</span>ℹ<span class="o">]</span>  node <span class="s2">&quot;ip-192-168-62-60.eu-west-2.compute.internal&quot;</span> is ready
<span class="o">[</span>ℹ<span class="o">]</span>  node <span class="s2">&quot;ip-192-168-67-118.eu-west-2.compute.internal&quot;</span> is ready
<span class="o">[</span>ℹ<span class="o">]</span>  kubectl <span class="nb">command</span> should work with <span class="s2">&quot;/home/debian/.kube/config&quot;</span>, try <span class="s1">&#39;kubectl get nodes&#39;</span>
<span class="o">[</span>✔<span class="o">]</span>  EKS cluster <span class="s2">&quot;first-eks&quot;</span> in <span class="s2">&quot;eu-west-2&quot;</span> region is ready
</code></pre></div>

<p>La instalación ya configura el acceso al cluster mediante <code>kubectl</code> automáticamente.</p>
<div class="codehilite"><pre><span></span><code>➜ kubectl get nodes
NAME                                           STATUS   ROLES    AGE     VERSION
ip-192-168-62-60.eu-west-2.compute.internal    Ready    &lt;none&gt;   3m18s   v1.15.10-eks-bac369
ip-192-168-67-118.eu-west-2.compute.internal   Ready    &lt;none&gt;   2m26s   v1.15.10-eks-bac369
</code></pre></div>

<h3 id="eliminar-cluster">Eliminar cluster</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># ver clusteres desplegados</span>
➜ eksctl get cluster --region eu-west-2
NAME        REGION
first-eks   eu-west-2

<span class="c1"># eliminar cluster</span>
➜ eksctl delete cluster --name first-eks --region eu-west-2
</code></pre></div>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href=".." title="Kubernetes" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Kubernetes
              </span>
            </div>
          </a>
        
        
          <a href="../Pod/" title="Pod" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Pod
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org" target="_blank" rel="noopener">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.c33a9706.js"></script>
      
      <script>app.initialize({version:"1.1",url:{base:".."}})</script>
      
    
  </body>
</html>