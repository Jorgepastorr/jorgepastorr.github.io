



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="http://kubernetes.jorgepastorr.tk:50022/aws/awseks/">
      
      
        <meta name="author" content="Jorge Pastor">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../images/kubernetes.png">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-4.6.3">
    
    
      
        <title>AWS EKS - Proyecto Kubernetes</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.adb8469c.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#3f51b5">
      
    
    
      <script src="../../assets/javascripts/modernizr.86422ebf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="500" height="500" viewBox="0 0 500 500" id="__gitlab"><path fill="currentColor" d="M93.667 473.347l90.684-279.097H2.983l90.684 279.097z" transform="translate(156.198 1.16)"/><path fill="currentColor" d="M221.333 473.345L130.649 194.25H3.557l217.776 279.095z" transform="translate(28.531 1.16)" opacity=".7"/><path fill="currentColor" d="M32 195.155L4.441 279.97a18.773 18.773 0 0 0 6.821 20.99l238.514 173.29L32 195.155z" transform="translate(.089 .256)" opacity=".5"/><path fill="currentColor" d="M2.667-84.844h127.092L75.14-252.942c-2.811-8.649-15.047-8.649-17.856 0L2.667-84.844z" transform="translate(29.422 280.256)"/><path fill="currentColor" d="M2.667 473.345L93.351 194.25h127.092L2.667 473.345z" transform="translate(247.198 1.16)" opacity=".7"/><path fill="currentColor" d="M221.334 195.155l27.559 84.815a18.772 18.772 0 0 1-6.821 20.99L3.557 474.25l217.777-279.095z" transform="translate(246.307 .256)" opacity=".5"/><path fill="currentColor" d="M130.667-84.844H3.575l54.618-168.098c2.811-8.649 15.047-8.649 17.856 0l54.618 168.098z" transform="translate(336.974 280.256)"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#aws-eks" tabindex="0" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="http://kubernetes.jorgepastorr.tk:50022" title="Proyecto Kubernetes" aria-label="Proyecto Kubernetes" class="md-header-nav__button md-logo">
          
            <img alt="logo" src="../../images/logokubernetes.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Proyecto Kubernetes
            </span>
            <span class="md-header-nav__topic">
              
                AWS EKS
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" aria-label="search" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://gitlab.com/jorgepastorr/kubernetes/" title="Go to repository" class="md-source" data-md-source="gitlab">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__gitlab" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    jorgepastorr/kubernetes
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="http://kubernetes.jorgepastorr.tk:50022" title="Proyecto Kubernetes" class="md-nav__button md-logo">
      
        <img alt="logo" src="../../images/logokubernetes.png" width="48" height="48">
      
    </a>
    Proyecto Kubernetes
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://gitlab.com/jorgepastorr/kubernetes/" title="Go to repository" class="md-source" data-md-source="gitlab">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__gitlab" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    jorgepastorr/kubernetes
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Kubernetes" class="md-nav__link">
      Kubernetes
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../Instalaci%C3%B3n/" title="Instalación" class="md-nav__link">
      Instalación
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../Pod/" title="Pod" class="md-nav__link">
      Pod
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../Replicaset/" title="Replicaset" class="md-nav__link">
      Replicaset
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../Deployment/" title="Deployment" class="md-nav__link">
      Deployment
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../Services_Endpoints/" title="Services & Endpoints" class="md-nav__link">
      Services & Endpoints
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../Namespaces/" title="Namespaces" class="md-nav__link">
      Namespaces
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../Limits/" title="Limits" class="md-nav__link">
      Limits
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../Probes/" title="Probes" class="md-nav__link">
      Probes
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../ConfigMaps/" title="ConfigMaps & Environtment" class="md-nav__link">
      ConfigMaps & Environtment
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../Secrets/" title="Secrets" class="md-nav__link">
      Secrets
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../Volumes/" title="Volumes" class="md-nav__link">
      Volumes
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../RBAC/" title="RBAC" class="md-nav__link">
      RBAC
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../Ingres/" title="Ingres" class="md-nav__link">
      Ingres
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../aws-cli/" title="AWS-clie" class="md-nav__link">
      AWS-clie
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        AWS EKS
      </label>
    
    <a href="./" title="AWS EKS" class="md-nav__link md-nav__link--active">
      AWS EKS
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#configurar-kubectl-con-cluster-aws" class="md-nav__link">
    Configurar kubectl con cluster aws
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#crear-cluster-aws-eks" class="md-nav__link">
    Crear cluster aws eks
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#crear-cluster-con-grupo-de-nodos" class="md-nav__link">
    Crear cluster con grupo de nodos.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#crear-cluster" class="md-nav__link">
    Crear cluster
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#anadir-nodos" class="md-nav__link">
    Añadir nodos
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ingress" class="md-nav__link">
    Ingress
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#requisitos" class="md-nav__link">
    Requisitos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ingress-controler" class="md-nav__link">
    Ingress controler
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ejemplo-aplicacion" class="md-nav__link">
    Ejemplo aplicación
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hpa" class="md-nav__link">
    HPA
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#metric-server" class="md-nav__link">
    Metric server
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#probar-hpa" class="md-nav__link">
    Probar HPA
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#volumes" class="md-nav__link">
    Volumes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cluster-autoscaler" class="md-nav__link">
    Cluster AutoScaler
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#requisitos_1" class="md-nav__link">
    Requisitos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deplegar-autoescaler" class="md-nav__link">
    Deplegar autoescaler
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#eliminar-cluster" class="md-nav__link">
    Eliminar cluster
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-17" type="checkbox" id="nav-17">
    
    <label class="md-nav__link" for="nav-17">
      presentacion
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-17">
        presentacion
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../presentacion/diapositiva.html" title="diapositiva" class="md-nav__link">
      diapositiva
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../presentacion/diapositiva.pdf" title="diapositiva-pdf" class="md-nav__link">
      diapositiva-pdf
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../presentacion/videos/" title="Videos" class="md-nav__link">
      Videos
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#configurar-kubectl-con-cluster-aws" class="md-nav__link">
    Configurar kubectl con cluster aws
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#crear-cluster-aws-eks" class="md-nav__link">
    Crear cluster aws eks
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#crear-cluster-con-grupo-de-nodos" class="md-nav__link">
    Crear cluster con grupo de nodos.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#crear-cluster" class="md-nav__link">
    Crear cluster
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#anadir-nodos" class="md-nav__link">
    Añadir nodos
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ingress" class="md-nav__link">
    Ingress
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#requisitos" class="md-nav__link">
    Requisitos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ingress-controler" class="md-nav__link">
    Ingress controler
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ejemplo-aplicacion" class="md-nav__link">
    Ejemplo aplicación
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hpa" class="md-nav__link">
    HPA
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#metric-server" class="md-nav__link">
    Metric server
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#probar-hpa" class="md-nav__link">
    Probar HPA
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#volumes" class="md-nav__link">
    Volumes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cluster-autoscaler" class="md-nav__link">
    Cluster AutoScaler
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#requisitos_1" class="md-nav__link">
    Requisitos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deplegar-autoescaler" class="md-nav__link">
    Deplegar autoescaler
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#eliminar-cluster" class="md-nav__link">
    Eliminar cluster
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://gitlab.com/jorgepastorr/kubernetes/edit/master/docs/aws/awseks.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="aws-eks">AWS EKS</h1>
<p><a href="https://docs.aws.amazon.com/eks/latest/userguide/what-is-eks.html">Documentación aws eks</a></p>
<h2 id="configurar-kubectl-con-cluster-aws">Configurar kubectl con cluster aws</h2>
<p>Al crear un cluster por defecto se  añade a kubectl automaticamente, en el caso de que no pase o se quiera acceder desde otro host, lanzar el siguiente comando</p>
<div class="codehilite"><pre><span></span><code>aws eks --region eu-west-2 update-kubeconfig --name first-eks
</code></pre></div>

<blockquote>
<p>previamente se a de tener aws configurado.</p>
</blockquote>
<h2 id="crear-cluster-aws-eks">Crear cluster aws eks</h2>
<p>En eks se puede crear el cluster con el grupo de nodos directamente o por separado, el resultado es el mismo</p>
<h3 id="crear-cluster-con-grupo-de-nodos">Crear cluster con grupo de nodos.</h3>
<div class="codehilite"><pre><span></span><code>eksctl create cluster <span class="se">\</span>
--name first-eks <span class="se">\</span>
--region eu-west-2 <span class="se">\</span>
--nodegroup-name standard-nodes <span class="se">\</span>
--node-type t3.medium <span class="se">\</span>
--nodes <span class="m">2</span> <span class="se">\</span>
--nodes-min <span class="m">2</span> <span class="se">\</span>
--nodes-max <span class="m">2</span> <span class="se">\</span>
--ssh-access <span class="se">\</span>
--ssh-public-key .ssh/id_rsa.pub <span class="se">\</span>
--managed
</code></pre></div>

<hr />
<h3 id="crear-cluster">Crear cluster</h3>
<div class="codehilite"><pre><span></span><code>eksctl create cluster <span class="se">\</span>
 --name test-cluster <span class="se">\</span>
 --version auto <span class="se">\</span>
 --without-nodegroup
</code></pre></div>

<h3 id="anadir-nodos">Añadir nodos</h3>
<div class="codehilite"><pre><span></span><code>eksctl create nodegroup <span class="se">\</span>
--cluster test-cluster <span class="se">\</span>
--version auto <span class="se">\</span>
--name standard-workers <span class="se">\</span>
--node-type t3.medium <span class="se">\</span>
--node-ami auto <span class="se">\</span>
--nodes <span class="m">3</span> <span class="se">\</span>
--nodes-min <span class="m">1</span> <span class="se">\</span>
--nodes-max <span class="m">3</span> <span class="se">\</span>
--asg-access
</code></pre></div>

<h2 id="ingress">Ingress</h2>
<p>En eks ingress controller necesita una serie de requisitos para poder desplegar <code>loadbalancer's</code> en aws, como serviceaccount, roles y una politica de aws. Si no se cumplen estos requisitos al tener el cluster dentro de aws, no se puede acceder a las aplicaciones desde el exterior.</p>
<p>En los siguientes pasos seguiré esta  <a href="https://docs.aws.amazon.com/eks/latest/userguide/alb-ingress.html">guia de requisitos</a>  que proporciona aws eks. </p>
<div class="codehilite"><pre><span></span><code>                                                +-------------+
                                                <span class="p">|</span> internet    <span class="p">|</span>
                            +---------------&gt;   +-------------+
                            +
                    LoadBalancer aws
                 +------------------+          AWS
        +------------------------------------------------------------+
        <span class="p">|</span>        <span class="p">|</span>                  <span class="p">|</span>                                <span class="p">|</span>
        <span class="p">|</span>        +------------------+                                <span class="p">|</span>
        <span class="p">|</span>                      ^                                     <span class="p">|</span>
        <span class="p">|</span>                      <span class="p">|</span>                                     <span class="p">|</span>
        <span class="p">|</span>           Cluster    <span class="p">|</span>                                     <span class="p">|</span>
        <span class="p">|</span>      +-------------------------------------------+         <span class="p">|</span>
        <span class="p">|</span>      <span class="p">|</span>   ingress controler        ingress rules  <span class="p">|</span>         <span class="p">|</span>
        <span class="p">|</span>      <span class="p">|</span>  +-----------+           +---------+      <span class="p">|</span>         <span class="p">|</span>
        <span class="p">|</span>      <span class="p">|</span>  <span class="p">|</span>           <span class="p">|</span>  &lt;--------+         <span class="p">|</span>      <span class="p">|</span>         <span class="p">|</span>
        <span class="p">|</span>      <span class="p">|</span>  +-----------+           +---------+      <span class="p">|</span>         <span class="p">|</span>
        <span class="p">|</span>      <span class="p">|</span>                                           <span class="p">|</span>         <span class="p">|</span>
        <span class="p">|</span>      <span class="p">|</span>                                           <span class="p">|</span>         <span class="p">|</span>
        <span class="p">|</span>      <span class="p">|</span>                                           <span class="p">|</span>         <span class="p">|</span>
        <span class="p">|</span>      <span class="p">|</span>                                           <span class="p">|</span>         <span class="p">|</span>
        <span class="p">|</span>      <span class="p">|</span>                                           <span class="p">|</span>         <span class="p">|</span>
        <span class="p">|</span>      <span class="p">|</span>                                           <span class="p">|</span>         <span class="p">|</span>
        <span class="p">|</span>      +-------------------------------------------+         <span class="p">|</span>
        +------------------------------------------------------------+
</code></pre></div>

<h3 id="requisitos">Requisitos</h3>
<p><strong>Asociar la IAM al cluster</strong></p>
<p>Esto es necesarió para asociar el usuario con el que se creará los loadbalancers en aws</p>
<div class="codehilite"><pre><span></span><code>eksctl utils associate-iam-oidc-provider <span class="se">\</span>
    --region eu-west-2 <span class="se">\</span>
    --cluster first-eks <span class="se">\</span>
    --approve
</code></pre></div>

<p><strong>Crear politica de aws</strong></p>
<p>El tipo de permisos que aporta aws al ingres controller</p>
<div class="codehilite"><pre><span></span><code>curl -o iam-policy.json https://raw.githubusercontent.com/kubernetes-sigs/aws-alb-ingress-controller/v1.1.4/docs/examples/iam-policy.json

aws iam create-policy <span class="se">\</span>
    --policy-name ALBIngressControllerIAMPolicy <span class="se">\</span>
    --policy-document file://iam-policy.json
</code></pre></div>

<p><strong>Serviceaccount</strong></p>
<p>Da permisos para la gestión dentro del cluster al controler</p>
<div class="codehilite"><pre><span></span><code>kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/aws-alb-ingress-controller/v1.1.4/docs/examples/rbac-role.yaml
</code></pre></div>

<p><strong>Unir politica con service account</strong></p>
<div class="codehilite"><pre><span></span><code>eksctl create iamserviceaccount <span class="se">\</span>
    --region eu-west-2 <span class="se">\</span>
    --name alb-ingress-controller <span class="se">\</span>
    --namespace kube-system <span class="se">\</span>
    --cluster first-eks <span class="se">\</span>
    --attach-policy-arn arn:aws:iam::111122223333:policy/ALBIngressControllerIAMPolicy <span class="se">\</span>
    --override-existing-serviceaccounts <span class="se">\</span>
    --approve
</code></pre></div>

<ul>
<li>el valor de <code>attach-policy-arn</code>  se encuentra en <code>IAM --&gt; Policies --&gt; buscar "ALBIngressControllerIAMPolicy" --&gt; policy ARN</code></li>
</ul>
<h3 id="ingress-controler">Ingress controler</h3>
<p><strong>Desplegar controller</strong></p>
<p>Este paso se puede ejecutar directamente y luego editar, o descargar el archivo, editarlo y desplegar. ( da lo mismo )</p>
<div class="codehilite"><pre><span></span><code>kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/aws-alb-ingress-controller/v1.1.4/docs/examples/alb-ingress-controller.yaml
</code></pre></div>

<p><strong>Editar deployment requerido</strong></p>
<div class="codehilite"><pre><span></span><code>kubectl edit deployment.apps/alb-ingress-controller -n kube-system

    spec:
      containers:
      - args:
        - --ingress-class<span class="o">=</span>alb
        - --cluster-name<span class="o">=</span>first-eks
</code></pre></div>

<ul>
<li>se tiene que añadir la línea  <code>- --cluster-name=first-eks</code> debajo de <code>- --ingress-class=alb</code></li>
</ul>
<h3 id="ejemplo-aplicacion">Ejemplo aplicación</h3>
<p>Esto es un ejemplo de una aplicación que ejecuta el juego 2048 para probar que todo funciona.</p>
<p><strong>Despliege de la aplicación</strong></p>
<div class="codehilite"><pre><span></span><code>kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/aws-alb-ingress-controller/v1.1.4/docs/examples/2048/2048-namespace.yaml
kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/aws-alb-ingress-controller/v1.1.4/docs/examples/2048/2048-deployment.yaml
kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/aws-alb-ingress-controller/v1.1.4/docs/examples/2048/2048-service.yaml
</code></pre></div>

<p>Crear un tunel al pod que a desplegado y acceder a la aplicación</p>
<div class="codehilite"><pre><span></span><code>kubectl port-fordward pod/2048-deployment-58fb54894c-7j6kp -n <span class="m">2048</span>-game <span class="m">7000</span>:80

firefox localhost:7000
</code></pre></div>

<ul>
<li><code>Port-forward</code> crea un tunel desde el puerto 80 del pod al puerto 7000 de mi host local. De esta manera compruebo que la aplicación funciona.</li>
</ul>
<p><strong>Exponer aplicacion con ingres aws</strong></p>
<p>Ahora despliego las reglas del ingres y automaticamente se creara un <code>LoadBalancer</code> en AWS. Se puede comprobar en  <code>EC2 --&gt; LoadBalancer</code></p>
<div class="codehilite"><pre><span></span><code>kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/aws-alb-ingress-controller/v1.1.4/docs/examples/2048/2048-ingress.yaml
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">extensions/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="s">&quot;2048-ingress&quot;</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="s">&quot;2048-game&quot;</span>
  <span class="nt">annotations</span><span class="p">:</span>
    <span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">alb</span>
    <span class="nt">alb.ingress.kubernetes.io/scheme</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">internet-facing</span>
  <span class="nt">labels</span><span class="p">:</span>
    <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2048-ingress</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">rules</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">http</span><span class="p">:</span>
        <span class="nt">paths</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/*</span>
            <span class="nt">backend</span><span class="p">:</span>
              <span class="nt">serviceName</span><span class="p">:</span> <span class="s">&quot;service-2048&quot;</span>
              <span class="nt">servicePort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
</code></pre></div>

<p><strong>Acceder a la aplicación desde ingres</strong></p>
<div class="codehilite"><pre><span></span><code>kubectl get ingress -n <span class="m">2048</span>-game
NAME          HOSTS   ADDRESS                                                                  PORTS
<span class="m">2048</span>-ingres   *       d7fftr876-2048-gameingr-1478-467912149875.eu-west-2.elb.amazonaws.com    <span class="m">80</span> 
</code></pre></div>

<ul>
<li><code>d7fftr876-2048-gameingr-1478-467912149875.eu-west-2.elb.amazonaws.com</code> es la direción dns pública que a creado el loadbalancer de aws.</li>
</ul>
<p>Ver aplicación</p>
<div class="codehilite"><pre><span></span><code>firefox d7fftr876-2048-gameingr-1478-467912149875.eu-west-2.elb.amazonaws.com
</code></pre></div>

<ul>
<li>Si se quiere cambiar la url, se tienen que gestionar el dns.</li>
</ul>
<p><strong>Eliminar aplicación y reglas de ingres</strong></p>
<div class="codehilite"><pre><span></span><code>kubectl delete -f https://raw.githubusercontent.com/kubernetes-sigs/aws-alb-ingress-controller/v1.1.4/docs/examples/2048/2048-ingress.yaml
kubectl delete -f https://raw.githubusercontent.com/kubernetes-sigs/aws-alb-ingress-controller/v1.1.4/docs/examples/2048/2048-service.yaml
kubectl delete -f https://raw.githubusercontent.com/kubernetes-sigs/aws-alb-ingress-controller/v1.1.4/docs/examples/2048/2048-deployment.yaml
kubectl delete -f https://raw.githubusercontent.com/kubernetes-sigs/aws-alb-ingress-controller/v1.1.4/docs/examples/2048/2048-namespace.yaml
</code></pre></div>

<h2 id="hpa">HPA</h2>
<p><strong>Horizontal pod autoescaler</strong> es un objeto que junto a un servidor de métricas, autoescala las replicas de una deployment según la cpu consumida en sus pods.  Es decir si una app empieza a tener mucha carga de cpu, HPA basandose en la cpu consumida en los pods,  empezará a replicar los pods para intentar desaogarlos.</p>
<p>Esto es muy útil en entornos de producción que en ciertas horas tienen picos de carga, ya que en horas puntas se  replicaran los pods necesarios y en horas bajas, se eliminaran los que sobren.</p>
<h3 id="metric-server">Metric server</h3>
<p>Para instalar el servidor de metrica kubernetes ya ofrece un template con todo lo necesario, solo se tiene que desplegar y verificar que funciona.</p>
<div class="codehilite"><pre><span></span><code>kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/download/v0.3.6/components.yaml

<span class="c1"># verificar</span>
kubectl get deployment metrics-server -n kube-system
NAME             READY   UP-TO-DATE   AVAILABLE   AGE
metrics-server   <span class="m">1</span>/1     <span class="m">1</span>            <span class="m">1</span>           6m
</code></pre></div>

<h3 id="probar-hpa">Probar HPA</h3>
<p>Para probar el funcionamiento de HPA, es necesario que el deployment desplegado tenga un limite de recursos en cpu establecido, en el siguiente caso <code>200m</code> que es un <code>0,2%</code> de una cpu. </p>
<div class="codehilite"><pre><span></span><code>kubectl run httpd --image<span class="o">=</span>httpd --requests<span class="o">=</span><span class="nv">cpu</span><span class="o">=</span>100m --limits<span class="o">=</span><span class="nv">cpu</span><span class="o">=</span>200m --expose --port<span class="o">=</span><span class="m">80</span>
</code></pre></div>

<p>Para probar el HPA creo un autoescalado al deployment <code>httpd</code> de mínimo 1 pod y máximo 5 donde si los pods superan el <code>50%</code>  empezaran a replicarse.</p>
<div class="codehilite"><pre><span></span><code>kubectl autoscale deployment httpd --cpu-percent<span class="o">=</span><span class="m">50</span> --min<span class="o">=</span><span class="m">1</span> --max<span class="o">=</span><span class="m">5</span>
</code></pre></div>

<p>Esto es un template de ejemplo que simula lo mismo que el comando anterior.</p>
<div class="codehilite"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">autoscaling/v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">HorizontalPodAutoscaler</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">httpd</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">scaleTargetRef</span><span class="p">:</span>
    <span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
    <span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Deployment</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">httpd</span>
  <span class="nt">minReplicas</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
  <span class="nt">maxReplicas</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
  <span class="nt">targetCPUUtilizationPercentage</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">50</span>
</code></pre></div>

<p>descripción de hpa</p>
<div class="codehilite"><pre><span></span><code>kubectl describe hpa httpd

Name:                                                  httpd
Namespace:                                             default
Labels:                                                &lt;none&gt;
Annotations:                                           &lt;none&gt;
CreationTimestamp:                                     Fri, <span class="m">27</span> Sep <span class="m">2019</span> <span class="m">13</span>:32:15 -0700
Reference:                                             Deployment/httpd
Metrics:                                               <span class="o">(</span> current / target <span class="o">)</span>
  resource cpu on pods  <span class="o">(</span>as a percentage of request<span class="o">)</span>:  <span class="m">1</span>% <span class="o">(</span>1m<span class="o">)</span> / <span class="m">50</span>%
Min replicas:                                          <span class="m">1</span>
Max replicas:                                          <span class="m">5</span>
Deployment pods:                                       <span class="m">1</span> current / <span class="m">1</span> desired
Conditions:
  Type            Status  Reason              Message
  ----            ------  ------              -------
  AbleToScale     True    ReadyForNewScale    recommended size matches current size
  ScalingActive   True    ValidMetricFound    the HPA was able to successfully calculate a replica count from cpu resource utilization <span class="o">(</span>percentage of request<span class="o">)</span>
  ScalingLimited  False   DesiredWithinRange  the desired count is within the acceptable range
Events:           &lt;none&gt;
</code></pre></div>

<p>Ahora despliego un deployment que empezara a hacer request al deployment anterior httpd y así aumentar la carga de cpu</p>
<div class="codehilite"><pre><span></span><code>kubectl run apache-bench -i --tty --rm --image<span class="o">=</span>httpd -- ab -n <span class="m">500000</span> -c <span class="m">1000</span> http://httpd.default.svc.cluster.local/
</code></pre></div>

<p>Al empezar a recibir carga se puede ver que los pods superan el 50% de limite establecido de cpu y hpa empieza a desplegar replicas, hasta llegar al limit de 5 replicas desplegadas.</p>
<div class="codehilite"><pre><span></span><code>kubectl get hpa
NAME    REFERENCE          TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
httpd   Deployment/httpd   <span class="m">76</span>%/50%   <span class="m">1</span>         <span class="m">5</span>         <span class="m">5</span>          4m50s
</code></pre></div>

<blockquote>
<p>HPA hace consultas al servidor de metricas por defecto cada 15s, entre que calcula los datos y demas puede tardar entre 30s o 40s a empezar a desplegar nuevas replicas.</p>
</blockquote>
<p>Ya hemos comprobado el aumento de replicas al subir la carga, ahora dejamos de mandar request para el proceso inverso ( eliminasr replicas ).</p>
<div class="codehilite"><pre><span></span><code>kubectl delete deployment.apps/httpd service/httpd horizontalpodautoscaler.autoscaling/httpd
</code></pre></div>

<p>HPA por defecto deja un timeout de 5m cuando la carga de cpu a bajado del límite establecido en este caso 50%, para prevenir futuras subidas, en caso de seguir 5m por debajo del 50% empieza a eliminar replicas.</p>
<div class="codehilite"><pre><span></span><code>kubectl get hpa
NAME    REFERENCE          TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
httpd   Deployment/httpd   <span class="m">0</span>%/50%    <span class="m">1</span>         <span class="m">5</span>         <span class="m">1</span>          12m50s
</code></pre></div>

<h2 id="volumes">Volumes</h2>
<p>https://aws.amazon.com/es/premiumsupport/knowledge-center/eks-persistent-storage/</p>
<p>https://docs.aws.amazon.com/eks/latest/userguide/storage-classes.html</p>
<h2 id="cluster-autoscaler">Cluster AutoScaler</h2>
<p><a href="https://docs.aws.amazon.com/eks/latest/userguide/cluster-autoscaler.html">documentación aws eks</a></p>
<p>Cluster AutoScaler añade o elimina nodos al cluster según los necesite, en el caso de que el cluster no tenga mas recursos para ejecutar pods, automaticamente añade otro nodo. En el caso contrario de que haya un nodo sin ser utilizado o desperdiciando recursos se movera el contenido a otro nodo y se eliminará el nodo.</p>
<p>En el autoescalado de un cluster siempre se asignara un mínimo y un máximo de nodos, que esto se indica en la creación del nodegroup del cluster.</p>
<p>En el desescalado  de nodos autoescaler por defecto espera 10m para verificar que un nodo realmente no se esta utilizando, una vez que un nodo este 10m sin uso y haber echo su verificación, se paará a la eliminación del nodo.</p>
<h3 id="requisitos_1">Requisitos</h3>
<p>Si has creado el cluster con <code>eksctl</code>  y añadido la opción <code>--asg-access</code>  en la creación del cluster, los requisitos para esta opción ya estan creados. En caso contrario seguir esta <a href="https://docs.aws.amazon.com/eks/latest/userguide/cluster-autoscaler.html">guia aws</a>, que tendras que asignar unos tags y roles a los nodos.</p>
<h3 id="deplegar-autoescaler">Deplegar autoescaler</h3>
<p>kubernetes ya nos proporciona el template con todo lo necesario para el despliegue de autoescaler, solo se tiene que lanzar las siguientes comandos y editar el template para añadir el nombre de nuestro cluster.</p>
<div class="codehilite"><pre><span></span><code>kubectl apply -f https://raw.githubusercontent.com/kubernetes/autoscaler/master/cluster-autoscaler/cloudprovider/aws/examples/cluster-autoscaler-autodiscover.yaml

kubectl -n kube-system annotate deployment.apps/cluster-autoscaler cluster-autoscaler.kubernetes.io/safe-to-evict<span class="o">=</span><span class="s2">&quot;false&quot;</span>
</code></pre></div>

<p>Al editar el template se busca la siguiente sección y se remplaza <code>&lt;YOUR CLUSTER NAME&gt;</code> por el nombre del cluster, tabién se añade las siguientes líneas <code>- --balance-similar-node-groups   - --skip-nodes-with-system-pods=false</code> para su correcto funcionamiento.</p>
<div class="codehilite"><pre><span></span><code>kubectl -n kube-system edit deployment.apps/cluster-autoscaler
</code></pre></div>

<div class="codehilite"><pre><span></span><code>    <span class="nt">spec</span><span class="p">:</span>
      <span class="nt">containers</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">command</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">./cluster-autoscaler</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--v=4</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--stderrthreshold=info</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--cloud-provider=aws</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--skip-nodes-with-local-storage=false</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--expander=least-waste</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--node-group-auto-discovery=asg:tag=k8s.io/cluster-autoscaler/enabled,k8s.io/cluster-autoscaler/&lt;YOUR CLUSTER NAME&gt;</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--balance-similar-node-groups</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--skip-nodes-with-system-pods=false</span>
</code></pre></div>

<h2 id="eliminar-cluster">Eliminar cluster</h2>
<p>Para eliminar un cluster, primero de todo es recomendable vaciarlo de todos los servicios, deployments, ...  que contenga. Después se puede eliminar  desde el navegador de aws o desde <code>eksctl</code>, si se elimina desde aws ir a la sección de stacks y eliminar siempre el stack de nodegroup primero, una vez haya finalizado eliminar el stack del cluster.</p>
<div class="codehilite"><pre><span></span><code>kubectl get svc --all-namespaces
kubectl delete svc service-name
eksctl delete cluster --name prod
</code></pre></div>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../../aws-cli/" title="AWS-clie" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                AWS-clie
              </span>
            </div>
          </a>
        
        
          <a href="../../presentacion/diapositiva.html" title="diapositiva" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                diapositiva
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org" target="_blank" rel="noopener">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.c33a9706.js"></script>
      
      <script>app.initialize({version:"1.1",url:{base:"../.."}})</script>
      
    
  </body>
</html>